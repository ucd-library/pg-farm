version: '3'

services:
  proxy:
    image: localhost/local-dev/pg-farm-service:main  
    ports:
      - "5432:5432"
    environment:
      - PROXY_DEBUG=true
      - GOOGLE_APPLICATION_CREDENTIALS=/etc/google/service-account.json
    env_file:
      - .env
    volumes:
      - ../../services/lib:/services/lib
      - ../../services/pg-proxy:/services/pg-proxy
      - ../../services/administration:/services/administration
      - ./service-account.json:/etc/google/service-account.json
    command: npm run proxy

  admin:
    image: localhost/local-dev/pg-farm-service:main  
    ports:
      - "3000:3000"
    environment:
      - SERVICE_PORT=3000
      - GOOGLE_APPLICATION_CREDENTIALS=/etc/google/service-account.json
    env_file:
      - .env
    volumes:
      - ./service-account.json:/etc/google/service-account.json
      - ../../services/lib:/services/lib
      - ../../services/pg-proxy:/services/pg-proxy
      - ../../services/authenticator:/services/authenticator
      - ../../services/administration:/services/administration
    command: npm run administration
    # command: bash -c "tail -f /dev/null"

  admin-db:
    build: ../../pg-instance
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=pgfarm
    volumes:
      - pg-admin-data:/var/lib/postgresql/data

  pg-test:
    build: ../../pg-instance
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    volumes:
      - pg-data:/var/lib/postgresql/data

volumes:
  pg-admin-data:
  pg-data: 